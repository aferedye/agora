#!/usr/bin/env bash
set -euo pipefail
[ -f ".env" ] && { set -a; . ".env"; set +a; }
LOG_FILE="${LOG_FILE:-var/logs/dubash.log}"

log(){ echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE" >tee -a "$LOG_FILE"2; }
require(){ command -v "$1" >/dev/null 2>&1 || { echo "âŒ Requis: $1"; exit 1; }; }
ensure_dirs(){ mkdir -p var/logs var/memory var/tmp; : > "$LOG_FILE"; }

help(){
cat <<HLP
Usage: ./dubash <cmd>
  up             Lance web
  down           Stop placeholder
  build          VÃ©rifie outils
  test           Placeholder
  status         Infos utiles
  logs           Tail logs
  web:up         Serveur statique
  web:open       Ouvre navigateur
  api:up         Lance API
  api:open       Ouvre /health
  api:status     Liste endpoints
  seed:circles   Remplit avec cercles de dÃ©mo
  dump:circles   Affiche cercles (JSON)
  clear:circles  Vide tous les cercles
HLP
}

cmd_build(){ ensure_dirs; log "ðŸ”§ VÃ©rifs"; require python3; log "âœ… OK"; }
cmd_up(){ ensure_dirs; log "ðŸš€ Start web"; ./dubash web:up; }
cmd_down(){ log "ðŸ›‘ Rien Ã  arrÃªter"; }
cmd_test(){ ensure_dirs; log "ðŸ§ª Rien pour l'instant"; }
cmd_status(){ ensure_dirs; echo "== ${AGORA_NAME:-Agora} (${AGORA_ENV:-dev}) =="; echo "Web: http://127.0.0.1:${WEB_PORT:-8080}"; echo "API: http://127.0.0.1:${API_PORT:-5050}"; }
cmd_logs(){ ensure_dirs; tail -n 200 -f "$LOG_FILE"; }

cmd_web_up(){ ensure_dirs; log "ðŸŒ web"; ./services/web/run.sh; }
cmd_web_open(){ port="${WEB_PORT:-8080}"; if command -v xdg-open >/dev/null; then xdg-open "http://127.0.0.1:${port}" >/dev/null 2>&1||true; elif command -v open >/dev/null; then open "http://127.0.0.1:${port}" >/dev/null 2>&1||true; else echo "â†’ http://127.0.0.1:${port}"; fi; }

cmd_api_up(){ ensure_dirs; log "ðŸ§© API â†’ start"; ./services/api/run.sh; }
cmd_api_open(){ [ -f ".env" ] && { set -a; . ".env"; set +a; }; : "${API_PORT:=5050}"; url="http://127.0.0.1:${API_PORT}/health"; if command -v xdg-open >/dev/null 2>&1; then xdg-open "$url" >/dev/null 2>&1||true; elif command -v open >/dev/null 2>&1; then open "$url" >/dev/null 2>&1||true; else echo "â†’ $url"; fi; }
cmd_api_status(){ [ -f ".env" ] && { set -a; . ".env"; set +a; }; : "${API_PORT:=5050}"; echo "API: http://127.0.0.1:${API_PORT}"; echo "Endpoints: GET /health, GET /time, POST /echo, CRUD /circles"; }

cmd_seed_circles(){
  ensure_dirs; require curl
  [ -f ".env" ] && { set -a; . ".env"; set +a; }; : "${API_PORT:=5050}"
  log "ðŸŒ± Seeding cercles"
  seeds='[
    {"title":"Agora â€” CÅ“ur","description":"Coordination, Ã©coute, cadence"},
    {"title":"Tech â€” Forge","description":"Backend, IA, orchestration Bash"},
    {"title":"Culture â€” Racines","description":"Art, rÃ©cit, mÃ©moire vivante"}
  ]'
  python3 - "$API_PORT" <<'PYSEED'
import sys, json, urllib.request
port = int(sys.argv[1])
seeds = json.loads(sys.stdin.read())
for s in seeds:
    req = urllib.request.Request(f"http://127.0.0.1:{port}/circles",
                                 data=json.dumps(s).encode("utf-8"),
                                 headers={"Content-Type":"application/json"})
    try:
        with urllib.request.urlopen(req) as resp:
            print("[seed] OK", s["title"], resp.status)
    except urllib.error.HTTPError as e:
        if e.code == 409:
            print("[seed] SKIP exists", s["title"])
        else:
            print("[seed] ERR", s["title"], e.code)
PYSEED
}

cmd_dump_circles(){
  ensure_dirs; require curl
  [ -f ".env" ] && { set -a; . ".env"; set +a; }; : "${API_PORT:=5050}"
  log "ðŸ“ Dump cercles"
  curl -s "http://127.0.0.1:${API_PORT}/circles"
}

cmd_clear_circles(){
  ensure_dirs
  [ -f ".env" ] && { set -a; . ".env"; set +a; }; : "${API_PORT:=5050}"
  if curl -sf "http://127.0.0.1:${API_PORT}/health" >/dev/null 2>&1; then
    log "ðŸ§½ Clear (via API)"
    ids=$(curl -s "http://127.0.0.1:${API_PORT}/circles" | python3 -c 'import sys,json; data=json.load(sys.stdin); print(" ".join(str(i["id"]) for i in data.get("items",[])))')
    for id in $ids; do
      curl -s -X DELETE "http://127.0.0.1:${API_PORT}/circles/$id" >/dev/null
      echo "[clear] id=$id"
    done
  else
    log "ðŸ§¼ Clear (wipe fichier)"
    echo "[]" > var/memory/circles.json
  fi
  log "âœ… Cercles vidÃ©s"
}

case "${1:-help}" in
  help|-h|--help) help ;;
  build) cmd_build ;;
  up) cmd_up ;;
  down) cmd_down ;;
  test) cmd_test ;;
  status) cmd_status ;;
  logs) cmd_logs ;;
  web:up) cmd_web_up ;;
  web:open) cmd_web_open ;;
  api:up) cmd_api_up ;;
  api:open) cmd_api_open ;;
  api:status) cmd_api_status ;;
  seed:circles) cmd_seed_circles ;;
  dump:circles) cmd_dump_circles ;;
  clear:circles) cmd_clear_circles ;;
  *) echo "Commande inconnue: $1"; echo; help; exit 1 ;;
  tree:circles) cmd_tree_circles ;;
  esac

cmd_tree_circles(){
  ensure_dirs
  require curl
  [ -f ".env" ] && { set -a; . ".env"; set +a; }
  : "${API_PORT:=5050}"
  log "ðŸŒ³ Tree cercles (ASCII)"
  python3 - "$API_PORT" <<'PYT'
import sys, json, urllib.request
port = int(sys.argv[1])

def fetch(url):
    with urllib.request.urlopen(url) as r:
        return json.loads(r.read().decode('utf-8'))

try:
    data = fetch(f"http://127.0.0.1:{port}/circles")
    items = data.get("items", [])
except Exception as e:
    # si API down, on lit le fichier local
    import os
    p = os.path.join("var","memory","circles.json")
    try:
        with open(p,"r",encoding="utf-8") as f:
            items = json.load(f)
    except Exception:
        items = []

by_id = {c["id"]: c for c in items}
children = {}
for c in items:
    children.setdefault(c.get("parent_id"), []).append(c)

def walk(pid=None, prefix=""):
    nodes = children.get(pid, [])
    for i, n in enumerate(sorted(nodes, key=lambda x: x.get("title","").lower())):
        is_last = (i == len(nodes)-1)
        branch = "â””â”€ " if is_last else "â”œâ”€ "
        print(prefix + branch + f"[{n['id']}] {n.get('title','')}")
        walk(n["id"], prefix + ("   " if is_last else "â”‚  "))

# racines
walk(None)
PYT
}
